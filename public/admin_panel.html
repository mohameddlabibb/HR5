<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Somabay Handbook Admin Panel</title>
    <!-- Optional: Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/public/css/main.css">
    <link rel="stylesheet" href="/public/css/admin.css">
    
</head>
<body>
    <div class="container">
        <h1>Admin Panel</h1>
        <p>Welcome, Admin!</p>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/public/js/admin_panel.js"></script>

    <!-- Admin Dashboard Section -->
    <section id="admin-dashboard" class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4>Dashboard</h4>
            <button id="logout-button" class="btn btn-warning">Logout</button>
        </div>

        <ul class="nav nav-tabs" id="adminTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="pages-tab" data-bs-toggle="tab" data-bs-target="#pages" type="button" role="tab" aria-controls="pages" aria-selected="true">Page Management</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="menus-tab" data-bs-toggle="tab" data-bs-target="#menus" type="button" role="tab" aria-controls="menus" aria-selected="false">Menu Builder</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="widgets-tab" data-bs-toggle="tab" data-bs-target="#widgets" type="button" role="tab" aria-controls="widgets" aria-selected="false">Widget System</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab" aria-controls="settings" aria-selected="false">CMS Settings</button>
            </li>
        </ul>
        <div class="tab-content" id="adminTabContent">
            <!-- Page Management Tab -->
            <div class="tab-pane fade show active" id="pages" role="tabpanel" aria-labelledby="pages-tab">
                <div class="card mt-3">
                    <div class="card-header">Page Management</div>
                    <div class="card-body">
                        <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#addPageModal">Add New Page/Chapter</button>
                        <div id="pages-list">
                            <!-- Pages will be listed here -->
                        </div>
                    </div>
                </div>

                <!-- Sidebar Structure Management -->
                <div class="card mt-3">
                    <div class="card-header">Sidebar Structure</div>
                    <div class="card-body">
                        <p>Drag and drop items below to reorder the sidebar. Click on a page to edit.</p>
                        <ul id="sidebar-sortable" class="list-group">
                            <!-- Sidebar items will be dynamically loaded and made sortable here -->
                        </ul>
                        <button id="save-sidebar-order" class="btn btn-primary mt-3">Save Sidebar Order</button>
                    </div>
                </div>
            </div>

            <!-- Menu Builder Tab -->
            <div class="tab-pane fade" id="menus" role="tabpanel" aria-labelledby="menus-tab">
                <div class="card mt-3">
                    <div class="card-header">Menu Builder</div>
                    <div class="card-body">
                        <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#addMenuModal">Add New Menu</button>
                        <div id="menus-list" class="mb-4">
                            <!-- Menus will be listed here -->
                        </div>

                        <div id="menu-editor-area" style="display: none;">
                            <h5>Edit Menu: <span id="current-menu-name"></span></h5>
                            <button id="add-menu-item-button" class="btn btn-info btn-sm mb-3">Add Menu Item</button>
                            <ul id="menu-items-sortable" class="list-group mb-3">
                                <!-- Menu items will be dynamically loaded and made sortable here -->
                            </ul>
                            <button id="save-menu-items-order" class="btn btn-primary me-2">Save Menu Structure</button>
                            <button id="cancel-menu-edit" class="btn btn-secondary">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Widget System Tab -->
            <div class="tab-pane fade" id="widgets" role="tabpanel" aria-labelledby="widgets-tab">
                <div class="card mt-3">
                    <div class="card-header">Widget System</div>
                    <div class="card-body">
                        <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#addWidgetModal">Add New Widget</button>
                        <div id="widgets-list">
                            <!-- Widgets will be listed here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- CMS Settings Tab -->
            <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="settings-tab">
                <div class="card mt-3">
                    <div class="card-header">CMS Settings</div>
                    <div class="card-body">
                        <p>Configure general CMS settings.</p>
                        <!-- CMS settings content will go here -->
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Modals for Add/Edit Page -->
    <!-- Add Page Modal -->
     
    <div class="modal fade" id="addPageModal" tabindex="-1" aria-labelledby="addPageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addPageModalLabel">Add New Page/Chapter</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                <form id="add-page-form" method="POST" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="add-page-title" class="form-label">Title</label>
                            <input type="text" class="form-control" id="add-page-title" required>
                        </div>
                        <!-- Slug is auto-generated; keep hidden to avoid user input -->
                        <input type="hidden" id="add-page-slug">
                        <div class="mb-3">
                            <label for="add-page-parent" class="form-label">Parent Chapter (optional)</label>
                            <select class="form-select" id="add-page-parent">
                                <option value="">-- No Parent (Top Level) --</option>
                                <!-- Options will be dynamically loaded -->
                            </select>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="add-page-is-chapter">
                            <label class="form-check-label" for="add-page-is-chapter">Is this a Chapter (can have sub-pages)?</label>
                        </div>
                        <div class="mb-3">
                            <label for="add-page-content" class="form-label">Content (HTML or Markdown)</label>
                            <textarea class="form-control" id="add-page-content" rows="10"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="add-page-image" class="form-label">Placeholder Image URL (e.g., /uploads/image.jpg)</label>
                            <input type="file" class="form-control" id="add-page-image" accept="image/*">
                        </div>
                        <div class="mb-3">
                            <label for="add-page-video" class="form-label">Embedded Video URL (e.g., YouTube embed link)</label>
                            <input type="file" class="form-control" id="add-page-video"  accept="video/*">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Media Preview</label>
                            <div id="media-preview-container" class="media-preview-container">
                                <p id="no-media-placeholder">No media uploaded yet</p>
                            </div>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="add-page-published" checked>
                            <label class="form-check-label" for="add-page-published">Published</label>
                        </div>
                        <div class="mb-3">
                            <label for="add-page-header-color" class="form-label">Header Color (e.g., #f8f9fa)</label>
                            <input type="color" class="form-control form-control-color" id="add-page-header-color" value="#f8f9fa">
                        </div>
                        <div class="mb-3">
                            <label for="add-page-header-image" class="form-label">Header Background Image URL (e.g., /uploads/header.jpg)</label>
                            <input type="file" class="form-control" id="add-page-header-image">
                        </div>
                        <div class="mb-3">
                            <label for="add-page-meta-description" class="form-label">Meta Description</label>
                            <textarea class="form-control" id="add-page-meta-description" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="add-page-meta-keywords" class="form-label">Meta Keywords (comma-separated)</label>
                            <input type="text" class="form-control" id="add-page-meta-keywords">
                        </div>
                        <div class="mb-3">
                            <label for="add-page-custom-css" class="form-label">Custom CSS</label>
                            <textarea class="form-control" id="add-page-custom-css" rows="5"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Page</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
document.addEventListener("DOMContentLoaded", function() {
    const addPageImageInput = document.getElementById("add-page-image");
    const addPageVideoInput = document.getElementById("add-page-video");
    const mediaPreviewContainer = document.getElementById("media-preview-container");
    const noMediaPlaceholder = document.getElementById("no-media-placeholder");

    function displayMediaPreview(file) {
        if (!file) {
            mediaPreviewContainer.innerHTML = '';
            noMediaPlaceholder.style.display = 'block';
            return;
        }

        noMediaPlaceholder.style.display = 'none';
        mediaPreviewContainer.innerHTML = ''; // Clear previous preview

        const reader = new FileReader();
        reader.onload = function(e) {
            const fileType = file.type.split('/')[0]; // "image" or "video"
            if (fileType === "image") {
                const img = document.createElement("img");
                img.src = e.target.result;
                img.classList.add("img-fluid", "mx-auto", "d-block", "mt-2"); // Bootstrap classes for responsiveness and centering
                mediaPreviewContainer.appendChild(img);
            } else if (fileType === "video") {
                const video = document.createElement("video");
                video.src = e.target.result;
                video.controls = true;
                video.classList.add("img-fluid", "mx-auto", "d-block", "mt-2"); // Bootstrap classes for responsiveness and centering
                mediaPreviewContainer.appendChild(video);
            }
        };
        reader.readAsDataURL(file);
    }

    addPageImageInput.addEventListener("change", function() {
        if (this.files && this.files[0]) {
            displayMediaPreview(this.files[0]);
            // Clear video input if image is selected
            addPageVideoInput.value = '';
        } else {
            displayMediaPreview(null);
        }
    });

    addPageVideoInput.addEventListener("change", function() {
        if (this.files && this.files[0]) {
            displayMediaPreview(this.files[0]);
            // Clear image input if video is selected
            addPageImageInput.value = '';
        } else {
            displayMediaPreview(null);
        }
    });

    document.getElementById("add-page-form").addEventListener("submit", async function(e) {
        e.preventDefault();

        // Gather basic text fields
        const title = document.getElementById("add-page-title").value;
        const parentId = document.getElementById("add-page-parent").value || null;
        const isChapter = document.getElementById("add-page-is-chapter").checked;
        const content = document.getElementById("add-page-content").value;

        // Auto-generate hierarchical slug using parent's slug when chosen
        function slugify(text) {
            return (text || "")
                .toString()
                .trim()
                .toLowerCase()
                .replace(/['"]/g, "")
                .replace(/[^a-z0-9]+/g, "-")
                .replace(/(^-|-$)+/g, "");
        }

        let slug;
        if (parentId) {
            const parentOption = document.querySelector(`#add-page-parent option[value="${parentId}"]`);
            const parentSlug = parentOption ? (parentOption.dataset.slug || "") : "";
            slug = (parentSlug ? `${parentSlug}-` : "") + slugify(title);
        } else {
            slug = slugify(title);
        }

        let placeholderImage = null;
        let embeddedVideo = null;

        async function uploadFile(file) {
            const formData = new FormData();
            formData.append("file", file);
            const res = await fetch("/api/admin/upload", {
                method: "POST",
                headers: {
                    "Authorization": "Bearer " + localStorage.getItem("adminToken")
                },
                body: formData
            });
            if (res.status === 401) {
                alert("Session expired. Please log in again.");
                localStorage.removeItem("adminToken");
                window.location.href = "/admin.html";
                return null;
            }
            const data = await res.json();
            if (res.ok) {
                return data.file_path;
            } else {
                alert("Upload failed: " + (data.message || res.statusText));
                return null;
            }
        }

        const imageFile = document.getElementById("add-page-image").files[0];
        if (imageFile) {
            placeholderImage = await uploadFile(imageFile);
        }

        const videoFile = document.getElementById("add-page-video").files[0];
        if (videoFile) {
            embeddedVideo = await uploadFile(videoFile);
        }

        const pagePayload = {
            title,
            slug,
            content,
            parent_id: parentId,
            is_chapter: isChapter,
            placeholder_image: placeholderImage,
            embedded_video: embeddedVideo
        };

        const res = await fetch("/api/admin/pages", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + localStorage.getItem("adminToken")
            },
            body: JSON.stringify(pagePayload)
        });

        if (res.status === 401) {
            alert("Session expired. Please log in again.");
            localStorage.removeItem("adminToken");
            window.location.href = "/admin.html";
            return;
        }

        const result = await res.json();
        if (res.ok) {
            alert("Page saved successfully!");
            window.location.reload();
        } else {
            alert("Error saving page: " + (result.message || res.statusText));
        }
    });
});
</script>

    <!-- Edit Page Modal -->
    <div class="modal fade" id="editPageModal" tabindex="-1" aria-labelledby="editPageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editPageModalLabel">Edit Page</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-page-form">
                        <input type="hidden" id="edit-page-id">
                        <div class="mb-3">
                            <label for="edit-page-title" class="form-label">Title</label>
                            <input type="text" class="form-control" id="edit-page-title" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-page-slug" class="form-label">Slug (URL path)</label>
                            <input type="text" class="form-control" id="edit-page-slug" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-page-content" class="form-label">Content (HTML or Markdown)</label>
                            <textarea class="form-control" id="edit-page-content" rows="10"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="edit-page-image" class="form-label">Placeholder Image URL</label>
                            <input type="text" class="form-control" id="edit-page-image">
                        </div>
                        <div class="mb-3">
                            <label for="edit-page-video" class="form-label">Embedded Video URL</label>
                            <input type="text" class="form-control" id="edit-page-video">
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="edit-page-published">
                            <label class="form-check-label" for="edit-page-published">Published</label>
                        </div>
                        <div class="mb-3">
                            <label for="edit-page-header-color" class="form-label">Header Color</label>
                            <input type="color" class="form-control form-control-color" id="edit-page-header-color">
                        </div>
                        <div class="mb-3">
                            <label for="edit-page-header-image" class="form-label">Header Background Image URL</label>
                            <input type="text" class="form-control" id="edit-page-header-image">
                        </div>
                        <div class="mb-3">
                            <label for="edit-page-meta-description" class="form-label">Meta Description</label>
                            <textarea class="form-control" id="edit-page-meta-description" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="edit-page-meta-keywords" class="form-label">Meta Keywords (comma-separated)</label>
                            <input type="text" class="form-control" id="edit-page-meta-keywords">
                        </div>
                        <div class="mb-3">
                            <label for="edit-page-custom-css" class="form-label">Custom CSS</label>
                            <textarea class="form-control" id="edit-page-custom-css" rows="5"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                        <button type="button" class="btn btn-danger" id="delete-page-button">Delete Page</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Menu Modal -->
    <div class="modal fade" id="addMenuModal" tabindex="-1" aria-labelledby="addMenuModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addMenuModalLabel">Add New Menu</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="add-menu-form">
                        <div class="mb-3">
                            <label for="new-menu-name" class="form-label">Menu Name</label>
                            <input type="text" class="form-control" id="new-menu-name" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Create Menu</button>
                        <div id="add-menu-message" class="mt-3"></div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Menu Item Modal -->
    <div class="modal fade" id="menuItemModal" tabindex="-1" aria-labelledby="menuItemModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="menuItemModalLabel">Add/Edit Menu Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="menu-item-form">
                        <input type="hidden" id="menu-item-id">
                        <div class="mb-3">
                            <label for="menu-item-title" class="form-label">Title</label>
                            <input type="text" class="form-control" id="menu-item-title" required>
                        </div>
                        <div class="mb-3">
                            <label for="menu-item-url" class="form-label">URL</label>
                            <input type="text" class="form-control" id="menu-item-url" required>
                        </div>
                        <div class="mb-3">
                            <label for="menu-item-target" class="form-label">Target</label>
                            <select class="form-select" id="menu-item-target">
                                <option value="_self">Same Window</option>
                                <option value="_blank">New Window</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Menu Item</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Widget Modal -->
    <div class="modal fade" id="addWidgetModal" tabindex="-1" aria-labelledby="addWidgetModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addWidgetModalLabel">Add New Widget</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="add-widget-form">
                        <div class="mb-3">
                            <label for="new-widget-name" class="form-label">Widget Name</label>
                            <input type="text" class="form-control" id="new-widget-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="new-widget-type" class="form-label">Widget Type</label>
                            <select class="form-select" id="new-widget-type" required>
                                <option value="">-- Select Type --</option>
                                <option value="text">Text/HTML</option>
                                <option value="image">Image</option>
                                <option value="social">Social Links</option>
                                <!-- Add more widget types as needed -->
                            </select>
                        </div>
                        <div class="mb-3" id="new-widget-data-container" style="display: none;">
                            <!-- Dynamic fields based on widget type -->
                        </div>
                        <button type="submit" class="btn btn-primary">Create Widget</button>
                        <div id="add-widget-message" class="mt-3"></div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Widget Modal -->
    <div class="modal fade" id="editWidgetModal" tabindex="-1" aria-labelledby="editWidgetModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editWidgetModalLabel">Edit Widget</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-widget-form">
                        <input type="hidden" id="edit-widget-name-hidden">
                        <div class="mb-3">
                            <label for="edit-widget-name" class="form-label">Widget Name</label>
                            <input type="text" class="form-control" id="edit-widget-name" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="edit-widget-type" class="form-label">Widget Type</label>
                            <select class="form-select" id="edit-widget-type" required>
                                <option value="">-- Select Type --</option>
                                <option value="text">Text/HTML</option>
                                <option value="image">Image</option>
                                <option value="social">Social Links</option>
                                <!-- Add more widget types as needed -->
                            </select>
                        </div>
                        <div class="mb-3" id="edit-widget-data-container">
                            <!-- Dynamic fields based on widget type -->
                        </div>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                        <button type="button" class="btn btn-danger" id="delete-widget-button">Delete Widget</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Upload Modal -->
    <div class="modal fade" id="uploadImageModal" tabindex="-1" aria-labelledby="uploadImageModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadImageModalLabel">Upload Image</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="image-upload-form">
                        <div class="mb-3">
                            <label for="image-file" class="form-label">Choose Image File</label>
                            <input type="file" class="form-control" id="image-file" accept="image/*" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Upload</button>
                        <div id="upload-message" class="mt-3"></div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery for Sortable (optional, can be replaced with vanilla JS if preferred) -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <!-- Optional: Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JavaScript -->
    <script src="js/admin_panel.js?v=1"></script>
</body>
</html>
